<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAI - 3D Multiplayer Voice Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        canvas { display: block; }
        .ui-overlay { position: fixed; z-index: 10; pointer-events: none; width: 100%; height: 100%; }
        .glass-panel { background: rgba(0, 20, 0, 0.85); border: 2px solid #0f0; pointer-events: auto; color: #0f0; box-shadow: 0 0 15px #0f0; }
        .mic-active { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px #0f0; } 50% { box-shadow: 0 0 20px #0f0; } 100% { box-shadow: 0 0 5px #0f0; } }
    </style>
</head>
<body>

    <div class="ui-overlay">
        <div class="glass-panel absolute top-4 right-4 p-4 rounded-lg w-60">
            <h2 class="text-center font-bold border-b border-green-900 pb-2 mb-2">SMAI VOICE SERVER</h2>
            <div id="status" class="text-xs text-yellow-400 mb-2">מתחבר למערכת...</div>
            <div id="player-count" class="text-[10px] mb-2 text-green-600">שחקנים בשרת: 0</div>
            <div id="players-list" class="space-y-1 text-xs"></div>
        </div>

        <div class="glass-panel absolute bottom-4 left-4 p-6 rounded-lg text-center">
            <p class="text-xs mb-4">כדי לדבר ולשחק, לחץ על הכפתור:</p>
            <button id="start-btn" class="bg-green-600 text-black px-6 py-2 font-bold hover:bg-white transition-all w-full rounded">התחבר ליחידה</button>
        </div>
    </div>

    <video id="webcam" class="fixed bottom-4 right-4 w-40 h-30 border-2 border-green-500 rounded hidden" autoplay playsinline muted></video>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Config - תחליף בנתונים שלך מה-Firebase Console ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let myId, myPeer, localStream;
        let players = {}; 
        
        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000800);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const grid = new THREE.GridHelper(200, 40, 0x00ff00, 0x002200);
        scene.add(grid);
        camera.position.set(0, 30, 40);
        camera.lookAt(0,0,0);

        // --- Voice & Logic ---
        async function startSystem() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('webcam').srcObject = localStream;
                document.getElementById('webcam').classList.remove('hidden');

                const userCredential = await signInAnonymously(auth);
                myId = userCredential.user.uid;
                
                myPeer = new Peer(myId);
                
                myPeer.on('open', id => {
                    document.getElementById('status').innerText = "סטטוס: מחובר | מזהה: " + id.slice(0,6);
                    setupMultiplayer();
                });

                myPeer.on('call', call => {
                    call.answer(localStream);
                    call.on('stream', remoteStream => playAudio(remoteStream));
                });

                document.getElementById('start-btn').parentElement.classList.add('hidden');
            } catch (err) {
                alert("חובה לאשר מיקרופון ומצלמה כדי לשחק.");
            }
        }

        function setupMultiplayer() {
            const playersCol = collection(db, "players");
            
            window.addEventListener('mousemove', (e) => {
                if (!myId) return;
                const x = (e.clientX / window.innerWidth) * 100 - 50;
                const z = (e.clientY / window.innerHeight) * 100 - 50;
                setDoc(doc(db, "players", myId), { x, z, id: myId, lastSeen: serverTimestamp() }, { merge: true });
            });

            onSnapshot(playersCol, (snapshot) => {
                const activeIds = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    activeIds.push(data.id);
                    if (data.id !== myId) {
                        if (!players[data.id]) {
                            createNewPlayer(data);
                            myPeer.call(data.id, localStream).on('stream', s => playAudio(s));
                        }
                        players[data.id].position.lerp(new THREE.Vector3(data.x, 1, data.z), 0.1);
                    }
                });
                
                Object.keys(players).forEach(id => {
                    if (!activeIds.includes(id)) {
                        scene.remove(players[id]);
                        delete players[id];
                    }
                });
                updateUI(activeIds);
            });
        }

        function createNewPlayer(data) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshPhongMaterial({ color: 0x00ff00 }));
            group.add(body);
            scene.add(group);
            players[data.id] = group;
        }

        function playAudio(stream) {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();
        }

        function updateUI(ids) {
            document.getElementById('player-count').innerText = "שחקנים בשרת: " + ids.length;
            document.getElementById('players-list').innerHTML = ids.map(id => `<div>• ${id === myId ? 'אני' : 'שחקן ' + id.slice(0,4)}</div>`).join('');
        }

        document.getElementById('start-btn').onclick = startSystem;

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
